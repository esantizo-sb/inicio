const classData = [
  {
    grade: '3ro B',
    code: 'UFHRDM',
    joinLink: 'https://frm.tv/join/UFHRDM'
  },
  {
    grade: '3ro A',
    code: 'MVQUE4',
    joinLink: 'https://frm.tv/join/MVQUE4'
  },
  {
    grade: '4to A',
    code: 'PC5CGF',
    joinLink: 'https://frm.tv/join/PC5CGF'
  },
  {
    grade: '4to B',
    code: '6HKH4B',
    joinLink: 'https://frm.tv/join/6HKH4B'
  },
  {
    grade: '5to A',
    code: 'V5L558',
    joinLink: 'https://frm.tv/join/V5L558'
  },
  {
    grade: '5to B',
    code: 'N8LTER',
    joinLink: 'https://frm.tv/join/N8LTER'
  },
  {
    grade: '6to A',
    code: 'HT3SZE',
    joinLink: 'https://frm.tv/join/HT3SZE'
  },
  {
    grade: '6to B',
    code: 'NLNAD9',
    joinLink: 'https://frm.tv/join/NLNAD9'
  },
  {
    grade: '7mo A',
    code: 'VJMD4Q',
    joinLink: 'https://frm.tv/join/VJMD4Q'
  },
  {
    grade: '7mo B',
    code: '32RZGH',
    joinLink: 'https://frm.tv/join/32RZGH'
  },
  {
    grade: '8vo A',
    code: 'TWVA8H',
    joinLink: 'https://frm.tv/join/TWVA8H'
  },
  {
    grade: '8vo B',
    code: 'GM8GSK',
    joinLink: 'https://frm.tv/join/GM8GSK'
  },
  {
    grade: '8vo C',
    code: 'YRKTVL',
    joinLink: 'https://frm.tv/join/YRKTVL'
  },
  {
    grade: '9no A',
    code: 'BR5R4V',
    joinLink: 'https://frm.tv/join/BR5R4V'
  },
  {
    grade: '9no B',
    code: 'TQDUAA',
    joinLink: 'https://frm.tv/join/TQDUAA'
  },
  {
    grade: '10mo A',
    code: 'XCMQEX',
    joinLink: 'https://frm.tv/join/XCMQEX'
  },
  {
    grade: '10mo B',
    code: 'Q68FZQ',
    joinLink: 'https://frm.tv/join/Q68FZQ'
  },
  {
    grade: '11mo A',
    code: 'C3GJZC',
    joinLink: 'https://frm.tv/join/C3GJZC'
  },
  {
    grade: '11mo B',
    code: 'M9R3LA',
    joinLink: 'https://frm.tv/join/M9R3LA'
  },
  {
    grade: 'Escuelita 4to',
    code: 'JBUY49',
    joinLink: 'https://frm.tv/join/JBUY49'
  },
  {
    grade: 'Escuelita 5to',
    code: 'H989YB',
    joinLink: 'https://frm.tv/join/H989YB'
  },
  {
    grade: 'Escuelita 6to',
    code: 'TTVDQX',
    joinLink: 'https://frm.tv/join/TTVDQX'
  }
];

const computerClasses = [
  {
    grade: '3th A - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc3NjQyNDc2?cjc=mi46jyt'
  },
  {
    grade: '3th B - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc4MTc3NTAy?cjc=37kixqv'
  },
  {
    grade: '4th A - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc4NDQyODE3?cjc=nvilo7w'
  },
  {
    grade: '4th B - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc3NTI1NjI0?cjc=qyvabdh'
  },
  {
    grade: '5th A - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc3Mjc0NzAw?cjc=2bkh7tt'
  },
  {
    grade: '5th B - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc4NDU2MTQx?cjc=pwwdlhf'
  },
  {
    grade: '6th A - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc3MTMzNzA0?cjc=qo72kvq'
  },
  {
    grade: '6th B - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc3ODg5ODI5?cjc=6ejc3p2'
  },
  {
    grade: '7th A - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc0Nzg0ODI5?cjc=aqsmsb3'
  },
  {
    grade: '7th B - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc2NDQ3OTQz?cjc=2r5r4h5'
  },
  {
    grade: '8th A - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc1NjY4OTUy?cjc=uy5nu6l'
  },
  {
    grade: '8th B - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc2MDQ3MzEy?cjc=cuvacm4'
  },
  {
    grade: '8th C - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc2MzM5ODA1?cjc=4rvhjmp'
  },
  {
    grade: '9th A - Computación',
    link: 'https://classroom.google.com/c/NzQ1MzczNTYzNzA1?cjc=hrxyltq'
  },
  {
    grade: '9th B - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc1ODc5MzE3?cjc=a4rovsv'
  },
  {
    grade: '10th A - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc1NDkyNDA0?cjc=msng6dp'
  },
  {
    grade: '10th B - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc2MTIxMzU3?cjc=3wifrgo'
  },
  {
    grade: '11th A - Computación',
    link: 'https://classroom.google.com/c/NzQ1Mzc2MTc1MDA3?cjc=2sxe2va'
  },
  {
    grade: '11th B - Computación',
    link: 'https://classroom.google.com/c/NzQ1MzU2MzMxNTk3?cjc=uzbeht6'
  }
];

// Sistema de gamificación
const gamificationSystem = {
  points: 0,
  level: 1,
  badges: [],
  visitedPlatforms: [],
  completedChallenges: [],
  
  // Inicializar desde localStorage
  init() {
    const savedData = localStorage.getItem('gamificationData');
    if (savedData) {
      const data = JSON.parse(savedData);
      this.points = data.points || 0;
      this.level = data.level || 1;
      this.badges = data.badges || [];
      this.visitedPlatforms = data.visitedPlatforms || [];
      this.completedChallenges = data.completedChallenges || [];
    }
    this.updateUI();
  },
  
  // Guardar en localStorage
  save() {
    localStorage.setItem('gamificationData', JSON.stringify({
      points: this.points,
      level: this.level,
      badges: this.badges,
      visitedPlatforms: this.visitedPlatforms,
      completedChallenges: this.completedChallenges
    }));
    this.updateUI();
  },
  
  // Añadir puntos
  addPoints(amount) {
    this.points += amount;
    this.checkLevelUp();
    this.save();
    
    // Mostrar animación de puntos
    this.showPointsAnimation(amount);
  },
  
  // Comprobar si sube de nivel
  checkLevelUp() {
    const nextLevel = Math.floor(this.points / 100) + 1;
    if (nextLevel > this.level) {
      this.level = nextLevel;
      this.showLevelUpAnimation();
    }
  },
  
  // Añadir insignia
  addBadge(badge) {
    if (!this.badges.includes(badge.id)) {
      this.badges.push(badge.id);
      this.save();
      this.showBadgeEarnedAnimation(badge);
    }
  },
  
  // Registrar visita a plataforma
  registerPlatformVisit(platformId) {
    if (!this.visitedPlatforms.includes(platformId)) {
      this.visitedPlatforms.push(platformId);
      this.addPoints(10);
      
      // Comprobar insignias de explorador
      if (this.visitedPlatforms.length === 5) {
        this.addBadge({
          id: 'explorer-bronze',
          name: 'Explorador de Bronce',
          description: 'Has visitado 5 plataformas diferentes',
          icon: 'fas fa-compass'
        });
      } else if (this.visitedPlatforms.length === 10) {
        this.addBadge({
          id: 'explorer-silver',
          name: 'Explorador de Plata',
          description: 'Has visitado 10 plataformas diferentes',
          icon: 'fas fa-globe-americas'
        });
      } else if (this.visitedPlatforms.length === 15) {
        this.addBadge({
          id: 'explorer-gold',
          name: 'Explorador de Oro',
          description: 'Has visitado 15 plataformas diferentes',
          icon: 'fas fa-globe'
        });
      }
      
      this.save();
    }
  },
  
  // Completar desafío
  completeChallenge(challengeId) {
    if (!this.completedChallenges.includes(challengeId)) {
      this.completedChallenges.push(challengeId);
      this.addPoints(25);
      this.save();
    }
  },
  
  // Actualizar interfaz de usuario
  updateUI() {
    const pointsElement = document.getElementById('user-points');
    const levelElement = document.getElementById('user-level');
    const badgesElement = document.getElementById('user-badges');
    
    if (pointsElement) pointsElement.textContent = this.points;
    if (levelElement) levelElement.textContent = this.level;
    
    if (badgesElement) {
      badgesElement.innerHTML = '';
      this.badges.forEach(badgeId => {
        const badge = this.getBadgeInfo(badgeId);
        const badgeElement = document.createElement('div');
        badgeElement.className = 'badge-item';
        badgeElement.innerHTML = `
          <i class="${badge.icon}"></i>
          <span class="badge-tooltip">${badge.name}: ${badge.description}</span>
        `;
        badgesElement.appendChild(badgeElement);
      });
    }
  },
  
  // Obtener información de insignia
  getBadgeInfo(badgeId) {
    const badgesInfo = {
      'explorer-bronze': {
        name: 'Explorador de Bronce',
        description: 'Has visitado 5 plataformas diferentes',
        icon: 'fas fa-compass'
      },
      'explorer-silver': {
        name: 'Explorador de Plata',
        description: 'Has visitado 10 plataformas diferentes',
        icon: 'fas fa-globe-americas'
      },
      'explorer-gold': {
        name: 'Explorador de Oro',
        description: 'Has visitado 15 plataformas diferentes',
        icon: 'fas fa-globe'
      },
      'search-master': {
        name: 'Maestro de Búsqueda',
        description: 'Has realizado 10 búsquedas en el portal',
        icon: 'fas fa-search'
      },
      'class-joiner': {
        name: 'Unido a Clases',
        description: 'Te has unido a 3 clases diferentes',
        icon: 'fas fa-graduation-cap'
      },
      'daily-visitor': {
        name: 'Visitante Diario',
        description: 'Has visitado el portal 5 días consecutivos',
        icon: 'fas fa-calendar-check'
      }
    };
    
    return badgesInfo[badgeId] || {
      name: 'Insignia Desconocida',
      description: 'Descripción no disponible',
      icon: 'fas fa-question-circle'
    };
  },
  
  // Animación de puntos ganados
  showPointsAnimation(points) {
    const pointsAnimation = document.createElement('div');
    pointsAnimation.className = 'points-animation';
    pointsAnimation.textContent = `+${points} puntos`;
    document.body.appendChild(pointsAnimation);
    
    setTimeout(() => {
      pointsAnimation.classList.add('show');
      
      setTimeout(() => {
        pointsAnimation.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(pointsAnimation);
        }, 300);
      }, 1500);
    }, 10);
  },
  
  // Animación de subida de nivel
  showLevelUpAnimation() {
    const levelUpAnimation = document.createElement('div');
    levelUpAnimation.className = 'level-up-animation';
    levelUpAnimation.innerHTML = `
      <div class="level-up-content">
        <i class="fas fa-arrow-up"></i>
        <h3>¡Subiste de Nivel!</h3>
        <p>Ahora eres nivel ${this.level}</p>
      </div>
    `;
    document.body.appendChild(levelUpAnimation);
    
    setTimeout(() => {
      levelUpAnimation.classList.add('show');
      
      setTimeout(() => {
        levelUpAnimation.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(levelUpAnimation);
        }, 300);
      }, 3000);
    }, 10);
  },
  
  // Animación de insignia ganada
  showBadgeEarnedAnimation(badge) {
    const badgeAnimation = document.createElement('div');
    badgeAnimation.className = 'badge-earned-animation';
    badgeAnimation.innerHTML = `
      <div class="badge-earned-content">
        <i class="${badge.icon}"></i>
        <h3>¡Nueva Insignia!</h3>
        <h4>${badge.name}</h4>
        <p>${badge.description}</p>
      </div>
    `;
    document.body.appendChild(badgeAnimation);
    
    setTimeout(() => {
      badgeAnimation.classList.add('show');
      
      setTimeout(() => {
        badgeAnimation.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(badgeAnimation);
        }, 300);
      }, 4000);
    }, 10);
  }
};

// Desafíos diarios
const dailyChallenges = [
  {
    id: 'visit-platforms',
    title: 'Explorador del Día',
    description: 'Visita 3 plataformas diferentes hoy',
    reward: 30,
    progress: 0,
    target: 3,
    icon: 'fas fa-compass'
  },
  {
    id: 'join-class',
    title: 'Únete a una Clase',
    description: 'Únete a una clase nueva hoy',
    reward: 25,
    progress: 0,
    target: 1,
    icon: 'fas fa-chalkboard-teacher'
  },
  {
    id: 'search-resources',
    title: 'Investigador',
    description: 'Realiza 5 búsquedas diferentes',
    reward: 20,
    progress: 0,
    target: 5,
    icon: 'fas fa-search'
  }
];

document.addEventListener('DOMContentLoaded', () => {
  // Inicializar sistema de gamificación
  gamificationSystem.init();
  
  // Crear panel de gamificación
  createGamificationPanel();
  
  // Crear panel de desafíos diarios
  createDailyChallengesPanel();
  
  const classGrid = document.getElementById('classGrid');
  
  // Populate class cards
  classData.forEach(classInfo => {
    const card = document.createElement('div');
    card.className = 'class-card';
    card.innerHTML = `
      <h3>${classInfo.grade}</h3>
      <p>Código de inscripción:</p>
      <div class="code">${classInfo.code}</div>
      <a href="${classInfo.joinLink}" class="join-link" data-class-id="${classInfo.code}">Unirse a la clase</a>
    `;
    classGrid.appendChild(card);
    
    // Añadir evento para registrar unión a clase
    const joinLink = card.querySelector('.join-link');
    joinLink.addEventListener('click', function() {
      const classId = this.getAttribute('data-class-id');
      // Registrar progreso en desafío
      updateChallengeProgress('join-class', 1);
      // Comprobar insignia de unirse a clases
      checkClassJoinerBadge(classId);
    });
  });

  // Crear panel de gamificación
  function createGamificationPanel() {
    const header = document.querySelector('header');
    const gamificationPanel = document.createElement('div');
    gamificationPanel.className = 'gamification-panel';
    gamificationPanel.innerHTML = `
      <div class="user-stats">
        <div class="stat-item">
          <i class="fas fa-star"></i>
          <span id="user-points">0</span>
          <span class="stat-label">Puntos</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-trophy"></i>
          <span id="user-level">1</span>
          <span class="stat-label">Nivel</span>
        </div>
        <div class="stat-item badges-container">
          <i class="fas fa-medal"></i>
          <div id="user-badges" class="badges-list"></div>
          <span class="stat-label">Insignias</span>
        </div>
      </div>
      <button id="challenges-toggle" class="challenges-button">
        <i class="fas fa-tasks"></i> Desafíos
      </button>
    `;
    
    document.body.insertBefore(gamificationPanel, header.nextSibling);
    
    // Evento para mostrar/ocultar panel de desafíos
    const challengesToggle = document.getElementById('challenges-toggle');
    challengesToggle.addEventListener('click', () => {
      const challengesPanel = document.getElementById('challenges-panel');
      challengesPanel.classList.toggle('show');
    });
  }
  
  // Crear panel de desafíos diarios
  function createDailyChallengesPanel() {
    const challengesPanel = document.createElement('div');
    challengesPanel.id = 'challenges-panel';
    challengesPanel.className = 'challenges-panel';
    
    let challengesHTML = `
      <div class="challenges-header">
        <h3><i class="fas fa-tasks"></i> Desafíos Diarios</h3>
        <button id="close-challenges" class="close-button"><i class="fas fa-times"></i></button>
      </div>
      <div class="challenges-list">
    `;
    
    dailyChallenges.forEach(challenge => {
      challengesHTML += `
        <div class="challenge-item" id="challenge-${challenge.id}">
          <div class="challenge-icon"><i class="${challenge.icon}"></i></div>
          <div class="challenge-info">
            <h4>${challenge.title}</h4>
            <p>${challenge.description}</p>
            <div class="challenge-progress">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${(challenge.progress / challenge.target) * 100}%"></div>
              </div>
              <div class="progress-text">${challenge.progress}/${challenge.target}</div>
            </div>
          </div>
          <div class="challenge-reward">
            <span>+${challenge.reward}</span>
            <i class="fas fa-star"></i>
          </div>
        </div>
      `;
    });
    
    challengesHTML += `
      </div>
    `;
    
    challengesPanel.innerHTML = challengesHTML;
    document.body.appendChild(challengesPanel);
    
    // Evento para cerrar panel de desafíos
    const closeButton = document.getElementById('close-challenges');
    closeButton.addEventListener('click', () => {
      challengesPanel.classList.remove('show');
    });
  }
  
  // Actualizar progreso de desafío
  function updateChallengeProgress(challengeId, amount = 1) {
    const challenge = dailyChallenges.find(c => c.id === challengeId);
    if (!challenge) return;
    
    challenge.progress = Math.min(challenge.progress + amount, challenge.target);
    
    // Actualizar UI
    const challengeElement = document.getElementById(`challenge-${challengeId}`);
    if (challengeElement) {
      const progressFill = challengeElement.querySelector('.progress-fill');
      const progressText = challengeElement.querySelector('.progress-text');
      
      progressFill.style.width = `${(challenge.progress / challenge.target) * 100}%`;
      progressText.textContent = `${challenge.progress}/${challenge.target}`;
      
      // Comprobar si se completó el desafío
      if (challenge.progress >= challenge.target) {
        challengeElement.classList.add('completed');
        // Otorgar recompensa si no se ha completado antes
        if (!gamificationSystem.completedChallenges.includes(challengeId)) {
          gamificationSystem.addPoints(challenge.reward);
          gamificationSystem.completeChallenge(challengeId);
        }
      }
    }
  }
  
  // Comprobar insignia de unirse a clases
  function checkClassJoinerBadge(classId) {
    // Añadir puntos por unirse a una clase
    gamificationSystem.addPoints(15);
    
    // Comprobar si ya se ha unido a 3 clases diferentes para otorgar insignia
    const joinedClasses = JSON.parse(localStorage.getItem('joinedClasses') || '[]');
    if (!joinedClasses.includes(classId)) {
      joinedClasses.push(classId);
      localStorage.setItem('joinedClasses', JSON.stringify(joinedClasses));
      
      if (joinedClasses.length === 3) {
        gamificationSystem.addBadge({
          id: 'class-joiner',
          name: 'Unido a Clases',
          description: 'Te has unido a 3 clases diferentes',
          icon: 'fas fa-graduation-cap'
        });
      }
    }
  }
  
  // Search functionality implementation
  const searchInput = document.getElementById('siteSearch');
  const searchButton = document.getElementById('searchButton');
  
  // Contador de búsquedas para insignia
  let searchCount = parseInt(localStorage.getItem('searchCount') || '0');
  
  /**
   * Search function to filter content on the page
   * @param {string} query - The search text entered by user
   */
  function performSearch(query) {
    // Convert query to lowercase for case-insensitive search
    const searchTerm = query.toLowerCase();
    
    // Clear previous search highlights
    document.querySelectorAll('.highlight').forEach(el => {
      el.classList.remove('highlight');
    });
    
    // If search is empty, show all elements
    if (searchTerm === '') {
      showAllElements();
      return;
    }
    
    // Incrementar contador de búsquedas y guardar
    searchCount++;
    localStorage.setItem('searchCount', searchCount.toString());
    
    // Actualizar progreso del desafío de búsqueda
    updateChallengeProgress('search-resources', 1);
    
    // Comprobar insignia de búsqueda
    if (searchCount === 10) {
      gamificationSystem.addBadge({
        id: 'search-master',
        name: 'Maestro de Búsqueda',
        description: 'Has realizado 10 búsquedas en el portal',
        icon: 'fas fa-search'
      });
    }
    
    // Arrays to track which elements match
    const matchingCards = [];
    const matchingClassCards = [];
    
    // Search in platform cards
    const platformCards = document.querySelectorAll('.platform-card');
    platformCards.forEach(card => {
      const cardText = card.textContent.toLowerCase();
      if (cardText.includes(searchTerm)) {
        matchingCards.push(card);
        // Highlight matching text
        highlightText(card, searchTerm);
      }
    });
    
    // Search in class cards
    const classCards = document.querySelectorAll('.class-card');
    classCards.forEach(card => {
      const cardText = card.textContent.toLowerCase();
      if (cardText.includes(searchTerm)) {
        matchingClassCards.push(card);
        // Highlight matching text
        highlightText(card, searchTerm);
      }
    });
    
    // Hide non-matching platform cards
    platformCards.forEach(card => {
      if (!matchingCards.includes(card)) {
        card.style.display = 'none';
      } else {
        card.style.display = '';
      }
    });
    
    // Hide non-matching class cards
    classCards.forEach(card => {
      if (!matchingClassCards.includes(card)) {
        card.style.display = 'none';
      } else {
        card.style.display = '';
      }
    });
    
    // Search in computer class cards (Google Classroom)
    searchComputerClasses(searchTerm);
    
    // Show sections with matches, hide others
    checkSectionVisibility();
  }
  
  /**
   * Helper function to highlight matching text within an element
   * @param {Element} element - The DOM element to search within
   * @param {string} term - The search term to highlight
   */
  function highlightText(element, term) {
    // Get all text nodes within the element
    const walker = document.createTreeWalker(
      element,
      NodeFilter.SHOW_TEXT,
      null,
      false
    );
    
    const textNodes = [];
    let node;
    while ((node = walker.nextNode())) {
      textNodes.push(node);
    }
    
    // Process each text node
    textNodes.forEach(textNode => {
      const parent = textNode.parentNode;
      const content = textNode.textContent;
      const lowerContent = content.toLowerCase();
      
      if (lowerContent.includes(term)) {
        // Split text by the search term
        const parts = [];
        let lastIndex = 0;
        let index;
        
        while ((index = lowerContent.indexOf(term, lastIndex)) !== -1) {
          // Add text before match
          if (index > lastIndex) {
            parts.push(document.createTextNode(content.substring(lastIndex, index)));
          }
          
          // Add highlighted match
          const span = document.createElement('span');
          span.className = 'highlight';
          span.textContent = content.substring(index, index + term.length);
          parts.push(span);
          
          lastIndex = index + term.length;
        }
        
        // Add remaining text
        if (lastIndex < content.length) {
          parts.push(document.createTextNode(content.substring(lastIndex)));
        }
        
        // Replace original text node with highlighted parts
        if (parts.length > 0) {
          const fragment = document.createDocumentFragment();
          parts.forEach(part => fragment.appendChild(part));
          parent.replaceChild(fragment, textNode);
        }
      }
    });
  }
  
  /**
   * Check which sections have visible elements and hide empty sections
   */
  function checkSectionVisibility() {
    // Check platform section
    const platformGrid = document.querySelector('.platform-grid');
    const visiblePlatforms = Array.from(platformGrid.querySelectorAll('.platform-card')).filter(
      card => card.style.display !== 'none'
    );
    
    const platformsSection = document.querySelector('.platforms');
    platformsSection.style.display = visiblePlatforms.length > 0 ? '' : 'none';
    
    // Check class section
    const classGridEl = document.getElementById('classGrid');
    const visibleClasses = Array.from(classGridEl.querySelectorAll('.class-card')).filter(
      card => card.style.display !== 'none'
    );
    
    const classSection = document.querySelector('.class-codes');
    classSection.style.display = visibleClasses.length > 0 ? '' : 'none';
  }
  
  /**
   * Reset the page to show all elements
   */
  function showAllElements() {
    // Show all platform cards
    document.querySelectorAll('.platform-card').forEach(card => {
      card.style.display = '';
    });
    
    // Show all class cards
    document.querySelectorAll('.class-card').forEach(card => {
      card.style.display = '';
    });
    
    // Show all sections
    document.querySelector('.platforms').style.display = '';
    document.querySelector('.class-codes').style.display = '';
  }
  
  // Event listener for search button click
  searchButton.addEventListener('click', () => {
    performSearch(searchInput.value);
  });
  
  // Event listener for search input (search as you type)
  searchInput.addEventListener('input', () => {
    performSearch(searchInput.value);
  });
  
  // Event listener for pressing Enter in search field
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      performSearch(searchInput.value);
    }
  });
  
  // Añadir eventos a las plataformas para registrar visitas
  document.querySelectorAll('.platform-card a').forEach(link => {
    link.addEventListener('click', function(e) {
      // Obtener ID único para la plataforma (usando href como identificador)
      const platformId = this.getAttribute('href');
      
      // Registrar visita a la plataforma
      gamificationSystem.registerPlatformVisit(platformId);
      
      // Actualizar progreso del desafío de visitar plataformas
      updateChallengeProgress('visit-platforms', 1);
      
      // Añadir puntos por visitar plataforma
      gamificationSystem.addPoints(5);
    });
  });
  
  // Comprobar si es la primera visita del día
  const lastVisitDate = localStorage.getItem('lastVisitDate');
  const today = new Date().toDateString();
  
  if (lastVisitDate !== today) {
    // Es una nueva visita diaria
    localStorage.setItem('lastVisitDate', today);
    
    // Incrementar contador de días consecutivos
    let consecutiveDays = parseInt(localStorage.getItem('consecutiveDays') || '0');
    consecutiveDays++;
    localStorage.setItem('consecutiveDays', consecutiveDays.toString());
    
    // Otorgar puntos por visita diaria
    gamificationSystem.addPoints(10);
    
    // Mostrar mensaje de bienvenida
    setTimeout(() => {
      const welcomeBack = document.createElement('div');
      welcomeBack.className = 'welcome-message';
      welcomeBack.innerHTML = `
        <div class="welcome-content">
          <i class="fas fa-calendar-check"></i>
          <h3>¡Bienvenido de nuevo!</h3>
          <p>Has visitado el portal ${consecutiveDays} día${consecutiveDays !== 1 ? 's' : ''} consecutivo${consecutiveDays !== 1 ? 's' : ''}.</p>
          <div class="welcome-reward">+10 <i class="fas fa-star"></i></div>
        </div>
      `;
      document.body.appendChild(welcomeBack);
      
      setTimeout(() => {
        welcomeBack.classList.add('show');
        
        setTimeout(() => {
          welcomeBack.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(welcomeBack);
          }, 300);
        }, 3000);
      }, 10);
    }, 1000);
    
    // Comprobar insignia de visitante diario
    if (consecutiveDays === 5) {
      gamificationSystem.addBadge({
        id: 'daily-visitor',
        name: 'Visitante Diario',
        description: 'Has visitado el portal 5 días consecutivos',
        icon: 'fas fa-calendar-check'
      });
    }
    
    // Reiniciar desafíos diarios
    dailyChallenges.forEach(challenge => {
      challenge.progress = 0;
    });
    
    // Actualizar UI de desafíos
    setTimeout(() => {
      dailyChallenges.forEach(challenge => {
        updateChallengeProgress(challenge.id, 0);
      });
    }, 500);
  }

  // Smooth scrolling for navigation links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth'
        });
      }
    });
  });

  // Contact form handling
  const contactForm = document.getElementById('contactForm');
  contactForm.addEventListener('submit', (e) => {
    e.preventDefault();
    // Add form submission logic here
    alert('Mensaje enviado exitosamente!');
    contactForm.reset();
  });

  // Computer classes grid
  const computerClassesGrid = document.getElementById('computerClassesGrid');
  
  // Populate computer classes grid
  computerClasses.forEach(classInfo => {
    const classCard = document.createElement('div');
    classCard.className = 'computer-class-card';
    
    // Extract class code from the link
    const codeMatch = classInfo.link.match(/cjc=([a-z0-9]+)/);
    const classCode = codeMatch ? codeMatch[1] : 'N/A';
    
    classCard.innerHTML = `
      <div class="class-icon">
        <i class="fas fa-chalkboard"></i>
      </div>
      <h3>${classInfo.grade}</h3>
      <div class="class-code">${classCode}</div>
      <a href="${classInfo.link}" class="join-class-btn" target="_blank">
        <i class="fas fa-sign-in-alt"></i> Ir a la clase
      </a>
    `;
    
    computerClassesGrid.appendChild(classCard);
    
    // Add event listener to track visits and award points
    const joinButton = classCard.querySelector('.join-class-btn');
    joinButton.addEventListener('click', function() {
      // Add points for joining a class
      gamificationSystem.addPoints(15);
      
      // Update challenge progress
      updateChallengeProgress('join-class', 1);
      
      // Check for class joiner badge
      checkClassJoinerBadge();
    });
  });
  
  // Function to search computer classes
  function searchComputerClasses(query) {
    const computerClassCards = document.querySelectorAll('.computer-class-card');
    let visibleCards = 0;
    
    computerClassCards.forEach(card => {
      const cardText = card.textContent.toLowerCase();
      if (query === '' || cardText.includes(query.toLowerCase())) {
        card.style.display = '';
        visibleCards++;
        
        // Highlight matching text if there's a query
        if (query !== '') {
          highlightText(card, query);
        }
      } else {
        card.style.display = 'none';
      }
    });
    
    // Show/hide the computer classes section based on search results
    const computerClassesSection = document.querySelector('.computer-classes');
    if (computerClassesSection) {
      computerClassesSection.style.display = visibleCards > 0 ? '' : 'none';
    }
    
    return visibleCards;
  }
});
